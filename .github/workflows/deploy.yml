name: 部署博客到服务器

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v3
      
      - name: 安装 pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: 安装 Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'pnpm'
      
      - name: 安装依赖
        run: pnpm install
      
      - name: 构建网站
        run: pnpm build:ssg
      
      - name: 压缩 dist
        run: tar -czf dist.tar.gz dist
      
      - name: 上传到服务器
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          source: "dist.tar.gz"
          target: "/tmp/"
      
      - name: 解压并部署
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            cd /www/wwwroot/blog_valaxy
            rm -rf dist.backup
            mv dist dist.backup 2>/dev/null || true
            tar -xzf /tmp/dist.tar.gz
            chown -R www:www dist
            chmod -R 755 dist
            rm /tmp/dist.tar.gz
            nginx -s reload
            echo "✅ 部署完成！"
