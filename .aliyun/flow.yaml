# é˜¿é‡Œäº‘äº‘æ•ˆ Flow é…ç½®æ–‡ä»¶
version: '1.0'
name: blog-valaxy-deploy
description: Valaxy åšå®¢è‡ªåŠ¨æ„å»ºéƒ¨ç½²

# è§¦å‘æ¡ä»¶
triggers:
  - type: push
    branch: main

# ç¯å¢ƒå˜é‡
variables:
  - name: NODE_VERSION
    value: '20'
  - name: PNPM_VERSION
    value: '8'

# æ„å»ºæ­¥éª¤
steps:
  # 1. æ£€å‡ºä»£ç 
  - name: æ£€å‡ºä»£ç 
    type: checkout
    params:
      depth: 1

  # 2. å®‰è£… Node.js
  - name: å®‰è£… Node.js
    type: nodejs
    params:
      version: ${NODE_VERSION}

  # 3. å®‰è£… pnpm
  - name: å®‰è£… pnpm
    type: shell
    params:
      script: |
        npm install -g pnpm@${PNPM_VERSION}
        pnpm --version

  # 4. å®‰è£…ä¾èµ–
  - name: å®‰è£…ä¾èµ–
    type: shell
    params:
      script: |
        echo "ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–..."
        pnpm install --frozen-lockfile

  # 5. æ„å»ºç½‘ç«™
  - name: æ„å»ºç½‘ç«™
    type: shell
    params:
      script: |
        echo "ğŸ”¨ å¼€å§‹æ„å»º..."
        NODE_OPTIONS="--max-old-space-size=4096" pnpm build:ssg
        echo "âœ… æ„å»ºå®Œæˆ"
        ls -lh dist/

  # 6. æ‰“åŒ…äº§ç‰©
  - name: æ‰“åŒ…äº§ç‰©
    type: shell
    params:
      script: |
        echo "ğŸ“¦ æ‰“åŒ… dist ç›®å½•..."
        tar -czf dist.tar.gz dist
        ls -lh dist.tar.gz

  # 7. ä¸Šä¼ åˆ°æœåŠ¡å™¨
  - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
    type: deploy-host
    params:
      host: ${SERVER_HOST}
      username: ${SERVER_USER}
      password: ${SERVER_PASSWORD}
      port: 22
      source: dist.tar.gz
      target: /tmp/
      commands:
        - cd /www/wwwroot/blog_valaxy
        - rm -rf dist.backup
        - mv dist dist.backup 2>/dev/null || true
        - tar -xzf /tmp/dist.tar.gz
        - chown -R www:www dist
        - chmod -R 755 dist
        - rm /tmp/dist.tar.gz
        - nginx -s reload
        - echo "âœ… éƒ¨ç½²å®Œæˆï¼"
        - echo "ğŸŒ è®¿é—®: https://kylaan.top"

# é€šçŸ¥é…ç½®
notifications:
  - type: dingtalk
    on_success: true
    on_failure: true
