<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>相册管理系统 - Kylaan's Blog</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    #app { max-width: 1200px; margin: 0 auto; }
    
    .login-box {
      background: white;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      max-width: 400px;
      margin: 100px auto;
    }
    
    .login-box h1 {
      margin-bottom: 30px;
      color: #333;
      text-align: center;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      color: #555;
      font-weight: 500;
    }
    
    input, textarea, select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .btn {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
    }
    
    .btn-primary:hover { background: #5568d3; }
    
    .btn-success {
      background: #48bb78;
      color: white;
    }
    
    .btn-success:hover { background: #38a169; }
    
    .btn-danger {
      background: #f56565;
      color: white;
      padding: 6px 12px;
      width: auto;
      font-size: 14px;
    }
    
    .btn-danger:hover { background: #e53e3e; }
    
    .admin-panel {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
    }
    
    .header h1 {
      color: #333;
    }
    
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      border-bottom: 2px solid #e0e0e0;
    }
    
    .tab {
      padding: 12px 24px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-size: 16px;
      color: #666;
      transition: all 0.3s;
    }
    
    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
      font-weight: 600;
    }
    
    .tab:hover { color: #667eea; }
    
    .upload-area {
      border: 2px dashed #ccc;
      border-radius: 8px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 20px;
    }
    
    .upload-area:hover {
      border-color: #667eea;
      background: #f7fafc;
    }
    
    .upload-area.dragover {
      border-color: #667eea;
      background: #ebf4ff;
    }
    
    .preview-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    
    .preview-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .preview-item .remove {
      position: absolute;
      top: 5px;
      right: 5px;
      background: rgba(0,0,0,0.6);
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-size: 16px;
      line-height: 1;
    }
    
    .albums-list {
      display: grid;
      gap: 15px;
    }
    
    .album-item {
      background: #f7fafc;
      padding: 20px;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s;
    }
    
    .album-item:hover {
      background: #edf2f7;
      transform: translateX(5px);
    }
    
    .album-info h3 {
      color: #333;
      margin-bottom: 5px;
    }
    
    .album-info p {
      color: #666;
      font-size: 14px;
    }
    
    .error {
      background: #fed7d7;
      color: #c53030;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 20px;
    }
    
    .build-status {
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 20px;
      font-weight: 500;
    }
    
    .build-status.building {
      background: #bee3f8;
      color: #2c5282;
    }
    
    .build-status.success {
      background: #c6f6d5;
      color: #22543d;
    }
    
    .build-status.error {
      background: #fed7d7;
      color: #c53030;
    }
    
    .success {
      background: #c6f6d5;
      color: #2f855a;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 20px;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- 登录界面 -->
    <div v-if="!isAuthenticated" class="login-box">
      <h1>🔐 相册管理系统</h1>
      <div v-if="error" class="error">{{ error }}</div>
      <form @submit.prevent="login">
        <div class="form-group">
          <label>管理员密码</label>
          <input type="password" v-model="password" placeholder="请输入密码" required>
        </div>
        <button type="submit" class="btn btn-primary">登录</button>
      </form>
    </div>

    <!-- 管理界面 -->
    <div v-else class="admin-panel">
      <div class="header">
        <h1>📸 相册管理系统</h1>
        <button @click="logout" class="btn btn-danger">退出登录</button>
      </div>

      <div class="tabs">
        <button class="tab" :class="{active: activeTab === 'create'}" @click="activeTab = 'create'">
          创建相册
        </button>
        <button class="tab" :class="{active: activeTab === 'list'}" @click="activeTab = 'list'">
          相册列表
        </button>
      </div>

      <!-- 创建相册 -->
      <div v-show="activeTab === 'create'">
        <div v-if="message" class="success">{{ message }}</div>
        <div v-if="error" class="error">{{ error }}</div>
        
        <!-- 构建状态提示 -->
        <div v-if="buildStatus.building" class="build-status building">
          🔨 正在构建网站，请稍候...
        </div>
        <div v-else-if="buildStatus.lastBuildSuccess === true" class="build-status success">
          ✅ 网站构建成功！最近构建时间: {{ formatTime(buildStatus.lastBuildTime) }}
        </div>
        <div v-else-if="buildStatus.lastBuildSuccess === false" class="build-status error">
          ❌ 构建失败: {{ buildStatus.lastBuildError }}
        </div>

        <form @submit.prevent="createAlbum">
          <div class="form-group">
            <label>相册标题 *</label>
            <input v-model="album.title" placeholder="例如：美好的一天" required>
          </div>

          <div class="form-group">
            <label>日期 *</label>
            <input type="date" v-model="album.date" required>
          </div>

          <div class="form-group">
            <label>相册描述</label>
            <textarea v-model="album.description" rows="3" placeholder="写点什么..."></textarea>
          </div>

          <div class="form-group">
            <label>访问密码（可选）</label>
            <input v-model="album.password" placeholder="留空则无需密码">
          </div>

          <div class="form-group">
            <label>上传照片 *</label>
            <div class="upload-area" @click="$refs.fileInput.click()" 
                 @dragover.prevent="isDragging = true"
                 @dragleave="isDragging = false"
                 @drop.prevent="handleDrop"
                 :class="{dragover: isDragging}">
              <p>📁 点击或拖拽上传照片</p>
              <p style="color: #999; margin-top: 10px; font-size: 14px;">支持 JPG、PNG、GIF、WebP</p>
            </div>
            <input ref="fileInput" type="file" multiple accept="image/*" 
                   @change="handleFileSelect" style="display: none;">
          </div>

          <div v-if="photos.length > 0" class="preview-grid">
            <div v-for="(photo, index) in photos" :key="index" class="preview-item">
              <img :src="photo.preview" :alt="photo.file.name">
              <button type="button" class="remove" @click="removePhoto(index)">×</button>
            </div>
          </div>

          <button type="submit" class="btn btn-success" :disabled="uploading || photos.length === 0">
            {{ uploading ? '上传中...' : '创建相册' }}
          </button>
        </form>
      </div>

      <!-- 相册列表 -->
      <div v-show="activeTab === 'list'">
        <div v-if="loading" class="loading">加载中...</div>
        
        <div v-else-if="albums.length === 0" class="loading">
          暂无相册
        </div>

        <div v-else class="albums-list">
          <div v-for="album in albums" :key="album.filename" class="album-item">
            <div class="album-info">
              <h3>{{ album.title }}</h3>
              <p>{{ album.date }}</p>
            </div>
            <div>
              <button @click="deleteAlbum(album.filename)" class="btn btn-danger">
                删除
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          isAuthenticated: false,
          password: '',
          adminPassword: '',
          error: '',
          message: '',
          activeTab: 'create',
          
          // 相册数据
          album: {
            title: '',
            date: new Date().toISOString().split('T')[0],
            description: '',
            password: ''
          },
          
          photos: [],
          isDragging: false,
          uploading: false,
          
          // 相册列表
          albums: [],
          loading: false,
          
          // 构建状态
          buildStatus: {
            building: false,
            lastBuildTime: null,
            lastBuildSuccess: null,
            lastBuildError: null
          },
          buildCheckInterval: null
        }
      },
      
      mounted() {
        // 定期检查构建状态
        if (this.isAuthenticated) {
          this.startBuildStatusCheck();
        }
      },
      
      beforeUnmount() {
        if (this.buildCheckInterval) {
          clearInterval(this.buildCheckInterval);
        }
      },
      
      methods: {
        async login() {
          try {
            const res = await fetch('/api/auth', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ password: this.password })
            });
            
            const data = await res.json();
            
            if (data.success) {
              this.isAuthenticated = true;
              this.adminPassword = this.password;
              this.error = '';
              this.loadAlbums();
            } else {
              this.error = '密码错误';
            }
          } catch (err) {
            this.error = '登录失败：' + err.message;
          }
        },
        
        logout() {
          this.isAuthenticated = false;
          this.password = '';
          this.adminPassword = '';
        },
        
        handleFileSelect(e) {
          this.addFiles(e.target.files);
        },
        
        handleDrop(e) {
          this.isDragging = false;
          this.addFiles(e.dataTransfer.files);
        },
        
        addFiles(files) {
          Array.from(files).forEach(file => {
            if (file.type.startsWith('image/')) {
              const reader = new FileReader();
              reader.onload = (e) => {
                this.photos.push({
                  file,
                  preview: e.target.result
                });
              };
              reader.readAsDataURL(file);
            }
          });
        },
        
        removePhoto(index) {
          this.photos.splice(index, 1);
        },
        
        async createAlbum() {
          if (this.photos.length === 0) {
            this.error = '请至少上传一张照片';
            return;
          }
          
          this.uploading = true;
          this.error = '';
          this.message = '';
          
          try {
            const formData = new FormData();
            formData.append('title', this.album.title);
            formData.append('date', this.album.date);
            formData.append('description', this.album.description);
            formData.append('password', this.album.password);
            
            this.photos.forEach((photo, index) => {
              formData.append('photos', photo.file);
              formData.append(`caption_${index}`, `照片 ${index + 1}`);
              formData.append(`desc_${index}`, '');
            });
            
            const res = await fetch('/api/albums', {
              method: 'POST',
              headers: { 'X-Admin-Password': this.adminPassword },
              body: formData
            });
            
            const data = await res.json();
            
            if (data.success) {
              this.message = data.message || '相册创建成功！';
              this.resetForm();
              this.loadAlbums();
              // 立即刷新构建状态
              this.checkBuildStatus();
            } else {
              this.error = data.error || '创建失败';
            }
          } catch (err) {
            this.error = '上传失败：' + err.message;
          } finally {
            this.uploading = false;
          }
        },
        
        async loadAlbums() {
          this.loading = true;
          try {
            const res = await fetch('/api/albums', {
              headers: { 'X-Admin-Password': this.adminPassword }
            });
            const data = await res.json();
            this.albums = data.albums || [];
          } catch (err) {
            this.error = '加载失败：' + err.message;
          } finally {
            this.loading = false;
          }
        },
        
        async deleteAlbum(filename) {
          if (!confirm('确定要删除这个相册吗？')) return;
          
          try {
            const res = await fetch(`/api/albums/${filename}`, {
              method: 'DELETE',
              headers: { 'X-Admin-Password': this.adminPassword }
            });
            
            const data = await res.json();
            
            if (data.success) {
              this.message = '相册已删除';
              this.loadAlbums();
            } else {
              this.error = data.error || '删除失败';
            }
          } catch (err) {
            this.error = '删除失败：' + err.message;
          }
        },
        
        resetForm() {
          this.album = {
            title: '',
            date: new Date().toISOString().split('T')[0],
            description: '',
            password: ''
          };
          this.photos = [];
        },
        
        // 检查构建状态
        async checkBuildStatus() {
          try {
            const res = await fetch('/api/build-status', {
              headers: { 'X-Admin-Password': this.adminPassword }
            });
            const data = await res.json();
            this.buildStatus = data;
          } catch (err) {
            console.error('获取构建状态失败:', err);
          }
        },
        
        // 开始定期检查构建状态
        startBuildStatusCheck() {
          this.checkBuildStatus();
          this.buildCheckInterval = setInterval(() => {
            this.checkBuildStatus();
          }, 5000); // 每5秒检查一次
        },
        
        // 格式化时间
        formatTime(isoString) {
          if (!isoString) return '';
          const date = new Date(isoString);
          return date.toLocaleString('zh-CN');
        }
      },
      
      watch: {
        isAuthenticated(newVal) {
          if (newVal) {
            this.startBuildStatusCheck();
          } else if (this.buildCheckInterval) {
            clearInterval(this.buildCheckInterval);
          }
        }
      }
    }).mount('#app');
  </script>
</body>
</html>
